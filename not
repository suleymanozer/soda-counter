# Rancher'ın repo'sunu ekle
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable

# Cert-manager'ın repo'sunu da ekleyelim, ne olur ne olmaz
helm repo add jetstack https://charts.jetstack.io

# Repo listesini güncelle
helm repo update


Ah, son düzlükte karşımıza çıkan bu hata, aslında çözümü en kolay olanlardan biri! Bu, "zor yol" kurulumlarının ne kadar güncel olduğunu gösteren tatlı bir sorun.

**Hatanın Açıklaması:**
`Error: INSTALLATION FAILED: chart requires kubeVersion: < 1.28.0-0 which is incompatible with Kubernetes v1.28.3`

Bu hata mesajı çok net:
*   **Ne Kurmaya Çalışıyoruz?** Rancher'ın `v2.8.2` versiyonunun Helm chart'ını.
*   **Chart Ne İstiyor?** Bu chart, `1.28.0` versiyonundan **daha eski** bir Kubernetes versiyonu (`< 1.28.0-0`) ile çalışmak üzere tasarlanmış.
*   **Bizim Kubernetes Versiyonumuz Ne?** `v1.28.3`.
*   **Sonuç:** `helm`, chart'ın istediği versiyon ile bizim cluster'ımızın versiyonu uyumsuz olduğu için kurulumu **daha başlamadan** durduruyor. Bu bir güvenlik önlemidir.

Bu, bizim cluster'ımızın, Rancher'ın o versiyonu için "çok yeni" olduğu anlamına geliyor.

### Çözüm: Rancher Versiyonunu Yükseltmek

Çözüm, bizim modern `v1.28.3` Kubernetes cluster'ımızla uyumlu olan daha yeni bir Rancher versiyonunu kullanmaktır.

Şu anki en güncel ve `v1.28` ile uyumlu olduğu bilinen Rancher versiyonlarından biri **`v2.8.4`**'tür. Şimdi tüm hazırlık sürecini bu yeni versiyon için hızlıca yapacağız.

---

### **RANCHER GÜNCELLEME PLANI**

#### Adım 1: Hazırlık Ortamını Temizle (PLAY WITH DOCKER veya Lokal Bilgisayar)

İnternete çıkan makineye geri dön. Eski Rancher dosyalarını temizleyelim.
```bash
# rancher-prep dizinine git
cd ~/rancher-prep

# Eski dosyaları sil
rm rancher-images.txt
rm -rf helm-charts/rancher-v2.8.2.tgz
rm -rf rancher-images/*rancher*
```

#### Adım 2: Yeni Rancher Versiyonunu Hazırla (İNTERNETLİ MAKİNE)

1.  **Yeni Chart'ı ve İmaj Listesini İndir:**
    *Dizin: `~/rancher-prep`*
    ```bash
    # YENİ VERSİYON: v2.8.4
    helm fetch rancher-stable/rancher --version=v2.8.4 -d ./helm-charts

    helm template ./helm-charts/rancher-v2.8.4.tgz | yq e '.. | select(has("image")) | .image' - | sort -u > rancher-images.txt
    ```

2.  **Yeni İmajları `.tar` Olarak Paketle:**
    ```bash
    cd rancher-images
    # Sadece yeni rancher listesindeki imajları indireceğiz
    while read -r img; do
      echo "--- İşleniyor: ${img} ---"
      docker pull "${img}"
      docker save -o "$(echo "${img}" | tr '/:' '-').tar" "${img}"
    done < ../rancher-images.txt
    ```

#### Adım 3: Yeni Paketleri `jumpbox`'a ve Worker'lara Taşı

1.  **`rancher-images`** dizinindeki yeni `.tar` dosyalarını ve `helm-charts` dizinindeki yeni `rancher-v2.8.4.tgz` dosyasını `jumpbox`'a taşı.
2.  **`jumpbox`**'tan, yeni imaj `.tar` dosyalarını `node-0` ve `node-1`'e `scp` ile gönder.
3.  **`node-0` ve `node-1`** üzerinde, yeni gelen bu `.tar` dosyalarını `sudo ctr -n k8s.io image import` komutuyla `containerd`'ye yükle.

*(Bu adımlar, daha önce yaptığımız işlemlerin aynısı, sadece yeni dosyalar için tekrarlıyoruz.)*

---

### Adım 4: Yeni Rancher Versiyonunu Kur (JUMPBOX)

Artık her şey hazır.

*`jumpbox` üzerinde, `helm-charts` dizininde:*
```bash
RANCHER_HOSTNAME="rancher.10.57.148.152.nip.io"

# YENİ ve DOĞRU CHART DOSYASINI KULLANIYORUZ
helm install rancher ./rancher-v2.8.4.tgz \
  --namespace cattle-system \
  --create-namespace \
  --set hostname=$RANCHER_HOSTNAME \
  --set bootstrapPassword=rancheradmin \
  --set replicas=1 \
  --set imagePullPolicy=IfNotPresent \
  --wait \
  --timeout 20m
```
Bu sefer, `helm` versiyon kontrolünü geçecek ve kurulum başlayacaktır. `cert-manager` zaten çalıştığı için, bu son adımın başarıyla tamamlanmasını bekliyoruz.
